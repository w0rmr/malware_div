#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <dirent.h>
#include <sys/stat.h>

// Function to encrypt/decrypt data using XOR
void xor_encrypt(char *data, size_t data_len, char *key, size_t key_len) {
    for (size_t i = 0; i < data_len; i++) {
        data[i] ^= key[i % key_len];
    }
}

// Function to read file content
char* read_file(const char *filename, size_t *size) {
    FILE *file = fopen(filename, "rb");
    if (!file) {
        perror("Failed to open file");
        return NULL;
    }

    fseek(file, 0, SEEK_END);
    *size = ftell(file);
    fseek(file, 0, SEEK_SET);

    char *buffer = (char*)malloc(*size);
    if (!buffer) {
        perror("Failed to allocate memory");
        fclose(file);
        return NULL;
    }

    fread(buffer, 1, *size, file);
    fclose(file);
    return buffer;
}

// Function to write data to a file
int write_file(const char *filename, char *data, size_t size) {
    FILE *file = fopen(filename, "wb");
    if (!file) {
        perror("Failed to open file for writing");
        return -1;
    }

    fwrite(data, 1, size, file);
    fclose(file);
    return 0;
}

int main() {
    DIR *d;
    struct dirent *dir;
    struct stat st;

    // Key for XOR decryption
    char key[] = "my_secret_key";
    size_t key_len = strlen(key);

    // Open the current directory
    d = opendir(".");
    if (!d) {
        perror("opendir");
        return 1;
    }

    // Read each file in the directory
    while ((dir = readdir(d)) != NULL) {
        // Skip directories
        if (stat(dir->d_name, &st) == 0 && S_ISDIR(st.st_mode)) {
            continue;
        }

        printf("Decrypting file: %s\n", dir->d_name);

        size_t size;
        char *data = read_file(dir->d_name, &size);
        if (!data) {
            continue;
        }

        // Decrypt the data
        xor_encrypt(data, size, key, key_len);

        // Write the decrypted data back to the file
        if (write_file(dir->d_name, data, size) != 0) {
            free(data);
            continue;
        }

        free(data);
    }

    closedir(d);

    printf("Decryption completed.\n");
    return 0;
}