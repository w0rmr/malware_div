#include <string.h>
#include <dirent.h>
#include <sys/stat.h>
#include <stdio.h>
#include <stdlib.h>
#include <limits.h>

// Function to encrypt/decrypt data using XOR
void xor_encrypt(char *data, size_t data_len, char *key, size_t key_len) {
    for (size_t i = 0; i < data_len; i++) {
        data[i] ^= key[i % key_len];
    }
}

// Function to read file content
char* read_file(const char *filename, size_t *size) {
    struct stat st;
    if (stat(filename, &st) != 0) {
        perror("Failed to get file status");
        return NULL;
    }

    if (S_ISDIR(st.st_mode)) {
        DIR *dir = opendir(filename);
        if (!dir) {
            perror("Failed to open directory");
            return NULL;
        }

        struct dirent *entry;
        while ((entry = readdir(dir)) != NULL) {
            // Skip the "." and ".." entries
            if (strcmp(entry->d_name, ".") == 0 || strcmp(entry->d_name, "..") == 0) {
                continue;
            }

            // Construct the full path of the file
            char path[PATH_MAX];
            snprintf(path, sizeof(path), "%s/%s", filename, entry->d_name);

            // Read and encrypt the file
            size_t file_size;
            char *file_data = read_file(path, &file_size);
            if (file_data) {
                xor_encrypt(file_data, file_size, "your_key", strlen("your_key"));
                // TODO: Write the encrypted data back to the file
                free(file_data);
            }
        }

        closedir(dir);
        return NULL;
    } else {
        FILE *file = fopen(filename, "rb");
        if (!file) {
            perror("Failed to open file");
            return NULL;
        }

        fseek(file, 0, SEEK_END);
        *size = ftell(file);
        fseek(file, 0, SEEK_SET);

        char *buffer = (char*)malloc(*size);
        if (!buffer) {
            perror("Failed to allocate memory");
            fclose(file);
            return NULL;
        }

        fread(buffer, 1, *size, file);
        fclose(file);
        return buffer;
    }
}
// Function to write data to a file
int write_file(const char *filename, char *data, size_t size) {
    FILE *file = fopen(filename, "wb");
    if (!file) {
        perror("Failed to open file for writing");
        return -1;
    }

    fwrite(data, 1, size, file);
    fclose(file);
    return 0;
}

int main(int ac , char **av) {

    if(ac != 3)
    {
        printf("usage $ %s key dir \n",av[0]);
        exit(1);
    }
    DIR *d;
    struct dirent *dir;
    struct stat st;

    // Key for XOR encryption
    char *key = av[1];
    size_t key_len = strlen(key);

    // Open the current directory
    d = opendir(av[2]);
    if (!d) {
        perror("opendir");
        return 1;
    }

    // Read each file in the directory
    while ((dir = readdir(d)) != NULL) {
        // Skip directories
        if (stat(dir->d_name, &st) == 0 && S_ISDIR(st.st_mode)) {
            continue;
        }

        // Construct full path to file
        char filepath[1024];
        snprintf(filepath, sizeof(filepath), "%s/%s", av[2], dir->d_name);

        printf("Encrypting file: %s\n", filepath);

        size_t size;
        char *data = read_file(filepath, &size);
        if (!data) {
            continue;
        }

        // Encrypt the data
        xor_encrypt(data, size, key, key_len);

        // Write the encrypted data back to the file
        if (write_file(filepath, data, size) != 0) {
            free(data);
            continue;
        }

        free(data);
    }

    closedir(d);

    printf("Encryption completed.\n");
    return 0;
}